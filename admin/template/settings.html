{{define "content"}}


<div class="tabs">
    <div class="tab-btn active" onclick="switchTab(this, 'basic')">基本设置</div>
    <div class="tab-btn" onclick="switchTab(this, 'db')">数据库设置</div>
    <div class="tab-btn" onclick="switchTab(this, 'redis')">Redis 缓存</div>
    <div class="tab-btn" onclick="switchTab(this, 'log')">日志设置</div>
</div>

<!-- BASIC SETTINGS TAB -->
<div id="basic" class="tab-content active">
    <!-- New Layout Container -->
    <div class="settings-container">
        <form id="settingsForm">
            <input type="hidden" name="update_type" value="basic">

            <!-- 1. 基本参数 (Basic Info) -->
            <div class="settings-header">基本参数</div>

            <div class="form-row">
                <label class="form-label">网站名称</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <input type="text" name="sitename" value="{{.Config.Site.SiteName}}" class="form-control"
                            required>
                    </div>
                    <span class="form-help">显示在 Logo 及浏览器标题上</span>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">PC端域名</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <!-- Assumed field or reusing Domain for now if exact mapping unclear, keeping strict to current struct -->
                        <input type="text" name="domain" value="{{.Config.Site.Domain}}" class="form-control">
                    </div>
                    <span class="form-help">绑定PC端域名</span>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">移动端域名</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <input type="text" name="mobile_domain" value="{{.Config.Site.MobileDomain}}"
                            class="form-control">
                    </div>
                    <span class="form-help">绑定移动端域名 (如 m.example.com)，识别后自动切换模版</span>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">强制域名</label>
                <div class="form-content">
                    <label class="custom-switch">
                        <input type="checkbox" name="force_domain" {{if .Config.Site.ForceDomain}}checked{{end}}>
                        <span class="switch-slider"></span>
                    </label>
                    <span class="form-help" style="margin-left: 15px;">开启后，非绑定域名无法访问前台页面</span>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">ID 转换规则</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <input type="text" name="id_trans_rule" value="{{.Config.Site.IdTransRule}}"
                            class="form-control" placeholder="例如: *2,+100">
                    </div>
                    <span class="form-help">公式：支持 +, -, *, /。按顺序运算。用于多站共库时区分 ID (需双向互逆算法)</span>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">PC端模板</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <input type="text" name="template" value="{{.Config.Site.Template}}" class="form-control"
                            placeholder="html">
                    </div>
                    <span class="form-help">PC端模板文件夹名称 (默认: html)</span>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">移动端模板</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <input type="text" name="mobile_template" value="{{.Config.Site.MobileTemplate}}"
                            class="form-control" placeholder="html_wap">
                    </div>
                    <span class="form-help">移动端模板文件夹名称</span>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">搜索间隔</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <input type="number" name="search_limit" value="{{.Config.Site.SearchLimit}}"
                            class="form-control" placeholder="0">
                    </div>
                    <span class="form-help">单位：秒，0 为不限制</span>
                </div>
            </div>

            <!-- 2. 存储设置 (Storage) -->
            <div class="settings-header" style="margin-top: 30px;">存储设置</div>

            <div class="form-row">
                <label class="form-label">存储模式</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <select name="storage_type" class="form-control" onchange="toggleStorageSettings(this.value)">
                            <option value="local" {{if eq .Config.Storage.Type "local" }}selected{{end}}>本地存储</option>
                            <option value="oss" {{if eq .Config.Storage.Type "oss" }}selected{{end}}>对象存储 (OSS)</option>
                        </select>
                    </div>
                    <span class="form-help">封面和小说文件的存储方式</span>
                </div>
            </div>

            <!-- Local Settings -->
            <div id="local-settings"
                style='display: {{if eq .Config.Storage.Type "local"}}block{{else}}none{{end}}; width: 100%;'>
                <div class="form-row">
                    <label class="form-label">本地路径</label>
                    <div class="form-content">
                        <div class="form-control-wrapper">
                            <input type="text" name="storage_path" value="{{.Config.Storage.Local.Path}}"
                                class="form-control" placeholder="files">
                        </div>
                        <span class="form-help">相对程序运行目录或绝对路径</span>
                    </div>
                </div>
            </div>

            <!-- OSS Settings -->
            <div id="oss-settings"
                style='display: {{if eq .Config.Storage.Type "oss"}}block{{else}}none{{end}}; width: 100%;'>
                <div class="form-row">
                    <label class="form-label">Endpoint</label>
                    <div class="form-content">
                        <div class="form-control-wrapper">
                            <input type="text" name="oss_endpoint" value="{{.Config.Storage.Oss.Endpoint}}"
                                class="form-control">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <label class="form-label">Bucket</label>
                    <div class="form-content">
                        <div class="form-control-wrapper">
                            <input type="text" name="oss_bucket" value="{{.Config.Storage.Oss.Bucket}}"
                                class="form-control">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <label class="form-label">Access Key</label>
                    <div class="form-content">
                        <div class="form-control-wrapper">
                            <input type="text" name="oss_access_key" value="{{.Config.Storage.Oss.AccessKey}}"
                                class="form-control">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <label class="form-label">Secret Key</label>
                    <div class="form-content">
                        <div class="form-control-wrapper">
                            <input type="password" name="oss_secret_key" value="{{.Config.Storage.Oss.SecretKey}}"
                                class="form-control">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <label class="form-label">访问域名</label>
                    <div class="form-content">
                        <div class="form-control-wrapper">
                            <input type="text" name="oss_domain" value="{{.Config.Storage.Oss.Domain}}"
                                class="form-control">
                        </div>
                        <span class="form-help">CDN 加速域名</span>
                    </div>
                </div>
            </div>

            <!-- 3. 参数设置 / 性能优化 -->
            <div class="settings-header" style="margin-top: 30px;">参数设置 (性能优化)</div>

            <div class="form-row">
                <label class="form-label">GZIP 压缩</label>
                <div class="form-content">
                    <label class="custom-switch">
                        <input type="checkbox" name="gzip_enabled" {{if .Config.Site.GzipEnabled}}checked{{end}}>
                        <span class="switch-slider"></span>
                    </label>
                    <span class="form-help" style="margin-left: 15px;">开启后自动压缩响应内容，大幅减少带宽消耗</span>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">首页缓存</label>
                <div class="form-content">
                    <label class="custom-switch">
                        <input type="checkbox" name="index_cache" {{if .Config.Site.IndexCache}}checked{{end}}>
                        <span class="switch-slider"></span>
                    </label>
                    <span class="form-help" style="margin-left: 15px;">缓存首页 HTML 1 分钟，高并发必备</span>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">小说详情缓存</label>
                <div class="form-content">
                    <label class="custom-switch">
                        <input type="checkbox" name="book_cache" {{if .Config.Site.BookCache}}checked{{end}}>
                        <span class="switch-slider"></span>
                    </label>
                    <span class="form-help" style="margin-left: 15px;">缓存小说信息页</span>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">章节目录缓存</label>
                <div class="form-content">
                    <label class="custom-switch">
                        <input type="checkbox" name="book_index_cache" {{if .Config.Site.BookIndexCache}}checked{{end}}>
                        <span class="switch-slider"></span>
                    </label>
                    <span class="form-help" style="margin-left: 15px;">建议开启，优化大长篇加载速度</span>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">章节阅读缓存</label>
                <div class="form-content">
                    <label class="custom-switch">
                        <input type="checkbox" name="read_cache" {{if .Config.Site.ReadCache}}checked{{end}}>
                        <span class="switch-slider"></span>
                    </label>
                    <span class="form-help" style="margin-left: 15px;">缓存章节内容，减轻数据库压力</span>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">分类页缓存</label>
                <div class="form-content">
                    <label class="custom-switch">
                        <input type="checkbox" name="sort_cache" {{if .Config.Site.SortCache}}checked{{end}}>
                        <span class="switch-slider"></span>
                    </label>
                    <span class="form-help" style="margin-left: 15px;">缓存分类筛选结果</span>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">排行榜缓存</label>
                <div class="form-content">
                    <label class="custom-switch">
                        <input type="checkbox" name="top_cache" {{if .Config.Site.TopCache}}checked{{end}}>
                        <span class="switch-slider"></span>
                    </label>
                    <span class="form-help" style="margin-left: 15px;">缓存常用榜单</span>
                </div>
            </div>


            <!-- Actions -->
            <div style="margin-top: 40px; padding-top: 20px; text-align: left; padding-left: 145px;">
                <button type="button" class="btn btn-teal" onclick="saveSettings()" style="padding: 8px 30px;">
                    <i class="fas fa-save"></i> 保存设置
                </button>
            </div>
        </form>
    </div>
</div>

<!-- DB SETTINGS TAB (Kept Functional but wrapped) -->
<div id="db" class="tab-content">
    <div class="settings-container">
        <div class="alert alert-warning" style="margin-bottom: 20px; border-left: 4px solid #f39c12;">
            <i class="fa fa-exclamation-triangle"></i> 警告：修改数据库配置可能导致系统无法连接数据库。
        </div>

        <form id="dbForm">
            <input type="hidden" name="update_type" value="db">

            <div class="form-row">
                <label class="form-label">驱动类型</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <input type="text" name="db_driver" value="{{.Config.Db.Driver}}" class="form-control"
                            placeholder="mysql">
                    </div>
                </div>
            </div>
            <div class="form-row">
                <label class="form-label">Host</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <input type="text" name="db_host" value="{{.Config.Db.Host}}" class="form-control">
                    </div>
                </div>
            </div>
            <div class="form-row">
                <label class="form-label">Port</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <input type="number" name="db_port" value="{{.Config.Db.Port}}" class="form-control">
                    </div>
                </div>
            </div>
            <div class="form-row">
                <label class="form-label">Database</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <input type="text" name="db_dbname" value="{{.Config.Db.DbName}}" class="form-control">
                    </div>
                </div>
            </div>
            <div class="form-row">
                <label class="form-label">User</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <input type="text" name="db_user" value="{{.Config.Db.User}}" class="form-control">
                    </div>
                </div>
            </div>
            <div class="form-row">
                <label class="form-label">Password</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <input type="password" name="db_password" value="{{.Config.Db.Password}}" class="form-control">
                    </div>
                </div>
            </div>

            <div class="settings-header" style="margin-top: 30px;">连接池设置</div>

            <div class="form-row">
                <label class="form-label">Max Open</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <input type="number" name="db_max_open"
                            value="{{if .Config.Db.MaxOpenConns}}{{.Config.Db.MaxOpenConns}}{{else}}200{{end}}"
                            class="form-control" placeholder="200">
                    </div>
                    <span class="form-help">最大打开连接数</span>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">Max Idle</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <input type="number" name="db_max_idle"
                            value="{{if .Config.Db.MaxIdleConns}}{{.Config.Db.MaxIdleConns}}{{else}}50{{end}}"
                            class="form-control" placeholder="50">
                    </div>
                    <span class="form-help">最大空闲连接数</span>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">Max Lifetime</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <input type="number" name="db_max_life"
                            value="{{if .Config.Db.ConnMaxLifetime}}{{.Config.Db.ConnMaxLifetime}}{{else}}300{{end}}"
                            class="form-control" placeholder="300">
                    </div>
                    <span class="form-help">连接最大生命周期 (秒)</span>
                </div>
            </div>

            <div style="margin-top: 30px; padding-left: 145px;">
                <button type="button" class="btn btn-info" onclick="testDbConnection()"
                    style="margin-right: 15px;">测试连接</button>
                <button type="submit" class="btn btn-teal">保存数据库配置</button>
            </div>
        </form>
    </div>
</div>

<!-- REDIS TAB -->
<div id="redis" class="tab-content">
    <div class="settings-container">
        <form id="redisForm">
            <input type="hidden" name="update_type" value="redis">

            <div class="form-row">
                <label class="form-label">状态</label>
                <div class="form-content">
                    <label class="custom-switch">
                        <input type="checkbox" name="redis_enabled" {{if .Config.Redis.Enabled}}checked{{end}}>
                        <span class="switch-slider"></span>
                    </label>
                    <span class="form-help" style="margin-left: 15px;">启用 Redis 缓存</span>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">Host</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <input type="text" name="redis_host" value="{{.Config.Redis.Host}}" class="form-control"
                            placeholder="localhost">
                    </div>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">Port</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <input type="number" name="redis_port"
                            value="{{if .Config.Redis.Port}}{{.Config.Redis.Port}}{{else}}6379{{end}}"
                            class="form-control">
                    </div>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">Password</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <input type="password" name="redis_password" value="{{.Config.Redis.Password}}"
                            class="form-control" placeholder="留空为无密码">
                    </div>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">DB Index</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <input type="number" name="redis_db" value="{{.Config.Redis.DB}}" class="form-control"
                            placeholder="0">
                    </div>
                </div>
            </div>

            <div style="margin-top: 30px; padding-left: 145px;">
                <button type="button" class="btn btn-info" onclick="testRedisConnection()"
                    style="margin-right: 15px;">测试连接</button>
                <button type="submit" class="btn btn-teal">保存 Redis 配置</button>
            </div>
        </form>
    </div>
</div>

<!-- LOG SETTINGS TAB -->
<div id="log" class="tab-content">
    <div class="settings-container">
        <form id="logForm">
            <input type="hidden" name="update_type" value="log">

            <div class="form-row">
                <label class="form-label">日志级别</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <select name="log_level" class="form-control">
                            <option value="debug" {{if eq .Config.Log.Level "debug" }}selected{{end}}>DEBUG (调试)
                            </option>
                            <option value="info" {{if eq .Config.Log.Level "info" }}selected{{end}}>INFO (信息)</option>
                            <option value="warn" {{if eq .Config.Log.Level "warn" }}selected{{end}}>WARN (警告)</option>
                            <option value="error" {{if eq .Config.Log.Level "error" }}selected{{end}}>ERROR (错误)
                            </option>
                        </select>
                    </div>
                    <span class="form-help">设置日志输出的最低级别</span>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">输出目标</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <select name="log_output" class="form-control">
                            <option value="stdout" {{if eq .Config.Log.Output "stdout" }}selected{{end}}>控制台 (stdout)
                            </option>
                            <option value="file" {{if eq .Config.Log.Output "file" }}selected{{end}}>文件</option>
                            <option value="both" {{if eq .Config.Log.Output "both" }}selected{{end}}>控制台+文件</option>
                        </select>
                    </div>
                    <span class="form-help">日志输出到控制台或文件</span>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">日志文件路径</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <input type="text" name="log_file_path" value="{{.Config.Log.FilePath}}" class="form-control"
                            placeholder="logs/app.log">
                    </div>
                    <span class="form-help">日志文件保存路径 (相对或绝对路径)</span>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">单文件最大大小 (MB)</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <input type="number" name="log_max_size" value="{{.Config.Log.MaxSize}}" class="form-control"
                            min="1" placeholder="10">
                    </div>
                    <span class="form-help">当日志文件超过此大小时自动切割</span>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">日志保留天数</label>
                <div class="form-content">
                    <div class="form-control-wrapper">
                        <input type="number" name="log_max_age" value="{{.Config.Log.MaxAge}}" class="form-control"
                            min="1" placeholder="7">
                    </div>
                    <span class="form-help">超过此天数的日志文件将被自动清理</span>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">HTTP 请求日志</label>
                <div class="form-content">
                    <label class="custom-switch">
                        <input type="checkbox" name="log_enable_http" {{if .Config.Log.EnableHTTP}}checked{{end}}>
                        <span class="switch-slider"></span>
                    </label>
                    <span class="form-help" style="margin-left: 15px;">记录每个 HTTP 请求的访问日志</span>
                </div>
            </div>

            <div style="margin-top: 30px; padding-left: 145px;">
                <button type="submit" class="btn btn-teal">保存日志配置</button>
            </div>
        </form>
    </div>
</div>

<script>
    function switchTab(btn, tabId) {
        // 移除所有激活状态
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        // 激活当前
        btn.classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }

    const settingsForm = document.getElementById('settingsForm');
    if (settingsForm) {
        settingsForm.addEventListener('submit', function (e) { handleSettingsSubmit(e, 'settingsForm'); });
    }

    const dbForm = document.getElementById('dbForm');
    if (dbForm) {
        dbForm.addEventListener('submit', function (e) { handleSettingsSubmit(e, 'dbForm'); });
    }

    const redisForm = document.getElementById('redisForm');
    if (redisForm) {
        redisForm.addEventListener('submit', function (e) { handleSettingsSubmit(e, 'redisForm'); });
    }

    async function handleSettingsSubmit(e, formId) {
        e.preventDefault();

    }

    // Global Save Function
    async function saveSettings() {
        const form = document.getElementById('settingsForm');
        const formData = new FormData(form);
        const body = new URLSearchParams(formData);

        try {
            const res = await fetch('{{.AdminPath}}/settings', {
                method: 'POST',
                body: body
            });
            const data = await res.json();
            if (data.success) {
                // Show a nice toast or alert
                alert('保存成功');
                location.reload();
            } else {
                alert('保存失败: ' + data.message);
            }
        } catch (err) {
            console.error(err);
            alert('网络错误');
        }
    }

    async function testDbConnection() {
        const form = document.getElementById('dbForm');
        const formData = new FormData(form);
        // Extract raw values for test
        const params = new URLSearchParams();
        params.append('driver', formData.get('db_driver'));
        params.append('host', formData.get('db_host'));
        params.append('port', formData.get('db_port'));
        params.append('user', formData.get('db_user'));
        params.append('password', formData.get('db_password'));
        params.append('dbname', formData.get('db_dbname'));

        try {
            const res = await fetch('{{.AdminPath}}/db/test', {
                method: 'POST',
                body: params
            });
            const data = await res.json();
            alert(data.message);
        } catch (err) {
            console.error(err);
            alert('网络错误');
        }
    }

    function toggleStorageSettings(type) {
        if (type === 'local') {
            document.getElementById('local-settings').style.display = 'block';
            document.getElementById('oss-settings').style.display = 'none';
        } else {
            document.getElementById('local-settings').style.display = 'none';
            document.getElementById('oss-settings').style.display = 'block';
        }
    }

    async function testRedisConnection() {
        // Similar to DB Test
        const form = document.getElementById('redisForm');
        const formData = new FormData(form);
        const params = new URLSearchParams();
        params.append('host', formData.get('redis_host'));
        params.append('port', formData.get('redis_port'));
        params.append('password', formData.get('redis_password'));
        params.append('db', formData.get('redis_db'));

        try {
            const res = await fetch('{{.AdminPath}}/redis/test', {
                method: 'POST',
                body: params
            });
            const data = await res.json();
            alert(data.message);
        } catch (err) {
            console.error(err);
            alert('网络错误');
        }
    }

    // Fix for form submissions in DB/Redis tabs
    document.getElementById('dbForm').onsubmit = async function (e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const body = new URLSearchParams(formData);

        try {
            const res = await fetch('{{.AdminPath}}/settings', {
                method: 'POST',
                body: body
            });
            const data = await res.json();
            if (data.success) {
                alert('保存成功');
                location.reload();
            } else {
                alert('保存失败: ' + data.message);
            }
        } catch (err) {
            alert('网络错误');
        }
    };

    document.getElementById('redisForm').onsubmit = document.getElementById('dbForm').onsubmit;
    document.getElementById('logForm').onsubmit = document.getElementById('dbForm').onsubmit;

</script>
{{end}}