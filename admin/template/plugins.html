{{define "content"}}
<div class="tabs">
    <div class="tab-btn active" onclick="switchTab(this, 'plugin-list')">插件列表</div>
    {{range $name, $cfg := .Plugins}}
    <div class="tab-btn" onclick="switchTab(this, 'plugin-{{$name}}')">{{$name}} 配置</div>
    {{end}}
</div>

<div id="plugin-list" class="tab-content active">
    <div class="card">
        <div class="alert alert-info">
            <strong><i class="fa fa-info-circle"></i> 插件管理说明：</strong>
            <ul style="margin: 5px 0 0 20px; font-size: 13px; color: #555;">
                <li>点击"启用/禁用"按钮可以切换插件状态</li>
                <li>点击插件名称对应的 Tab 标签可以进入配置页面</li>
                <li>配置修改后会立即生效，无需重启应用</li>
            </ul>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th width="20%">插件名称</th>
                        <th width="15%">状态</th>
                        <th>描述</th>
                        <th width="15%">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {{range $name, $cfg := .Plugins}}
                    <tr>
                        <td><strong>{{$name}}</strong></td>
                        <td>
                            {{if index $cfg "enabled"}}
                            <span class="badge badge-success">已启用</span>
                            {{else}}
                            <span class="badge badge-secondary">已禁用</span>
                            {{end}}
                        </td>
                        <td style="color: #666; font-size: 13px;">
                            {{if eq $name "langtail"}}
                            长尾关键词插件 - 自动从百度获取搜索建议词优化SEO
                            {{else}}
                            -
                            {{end}}
                        </td>
                        <td>
                            {{if index $cfg "enabled"}}
                            <button class="btn btn-warning btn-sm" onclick="togglePlugin('{{$name}}', false)">
                                禁用
                            </button>
                            {{else}}
                            <button class="btn btn-success btn-sm" onclick="togglePlugin('{{$name}}', true)">
                                启用
                            </button>
                            {{end}}
                        </td>
                    </tr>
                    {{else}}
                    <tr>
                        <td colspan="4" style="text-align: center; color: #999; padding: 40px;">
                            暂无已安装的插件
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
    </div>
</div>

{{range $name, $cfg := .Plugins}}
<div id="plugin-{{$name}}" class="tab-content">
    <div class="card">
        <form id="form-{{$name}}" onsubmit="savePluginConfig(event, '{{$name}}')">
            <div class="alert alert-info" style="margin-bottom: 20px;">
                <strong><i class="fa fa-cog"></i> {{$name}} 插件配置</strong>
                <span style="font-size: 13px; color: #555; margin-left: 10px;">
                    {{if index $cfg "enabled"}}
                    <span class="badge badge-success">已启用</span>
                    {{else}}
                    <span class="badge badge-secondary">已禁用</span>
                    {{end}}
                </span>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                {{range $key, $value := $cfg}}
                {{if ne $key "enabled"}}
                <div class="config-item"
                    style="background: #f9f9f9; padding: 15px; border-radius: 5px; border: 1px solid #eee;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <label style="font-weight: bold; font-size: 14px; color: #333;">{{$key}}</label>
                        <span style="font-size: 12px; color: #999;">
                            {{if eq $key "fetch_cycle_days"}}抓取周期(天){{end}}
                            {{if eq $key "cache_seconds"}}缓存时间(秒){{end}}
                            {{if eq $key "route_pattern"}}URL路由模式{{end}}
                        </span>
                    </div>
                    <input type="text" class="form-control config-input" data-key="{{$key}}" value="{{$value}}"
                        style="width: 100%; padding: 10px; box-sizing: border-box;">
                </div>
                {{end}}
                {{end}}
            </div>

            <div class="form-actions" style="margin-top: 30px; text-align: center;">
                <button type="submit" class="btn btn-primary" style="padding: 10px 50px; font-size: 16px;">
                    保存配置
                </button>
            </div>
        </form>
    </div>
</div>
{{end}}

<style>
    .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }

    .badge-success {
        background-color: #4caf50;
        color: white;
    }

    .badge-secondary {
        background-color: #9e9e9e;
        color: white;
    }

    .btn-sm {
        padding: 4px 12px;
        font-size: 12px;
    }

    .btn-warning {
        background-color: #ff9800;
        color: white;
    }

    .btn-warning:hover {
        background-color: #f57c00;
    }

    .btn-success {
        background-color: #4caf50;
        color: white;
    }

    .btn-success:hover {
        background-color: #388e3c;
    }
</style>

<script>
    function switchTab(btn, tabId) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        btn.classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }

    // 切换插件状态
    async function togglePlugin(name, enabled) {
        const action = enabled ? '启用' : '禁用';
        if (!confirm(`确定要${action}插件 "${name}" 吗？`)) {
            return;
        }

        try {
            const res = await fetch('{{.AdminPath}}/plugins/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name, enabled: enabled })
            });
            const data = await res.json();
            if (data.success) {
                alert(`${action}成功`);
                location.reload();
            } else {
                alert('操作失败: ' + data.message);
            }
        } catch (err) {
            alert('网络错误');
        }
    }

    // 保存插件配置
    async function savePluginConfig(e, name) {
        e.preventDefault();
        const form = document.getElementById(`form-${name}`);
        const inputs = form.querySelectorAll('.config-input');
        const config = {};

        inputs.forEach(input => {
            const key = input.dataset.key;
            let value = input.value;

            // 尝试转换数字
            if (!isNaN(value) && value !== '') {
                value = parseFloat(value);
            }
            // 处理布尔值
            if (value === 'true') value = true;
            if (value === 'false') value = false;

            config[key] = value;
        });

        try {
            const res = await fetch('{{.AdminPath}}/plugins/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name, config: config })
            });
            const data = await res.json();
            if (data.success) {
                alert('配置保存成功');
                location.reload();
            } else {
                alert('保存失败: ' + data.message);
            }
        } catch (err) {
            alert('网络错误');
        }
    }
</script>
{{end}}