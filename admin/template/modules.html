{{define "content"}}
<div class="tabs">
    <div class="tab-btn active" onclick="switchTab(this, 'routes')">URL 路由设置</div>
    <div class="tab-btn" onclick="switchTab(this, 'sorts')">小说分类设置</div>
    <div class="tab-btn" onclick="switchTab(this, 'seo')">SEO 规则设置</div>
</div>

<div id="routes" class="tab-content active">
    <div class="card">
        <form id="routes-form" onsubmit="saveRoutes(event)">
            <div class="alert alert-info">
                <strong><i class="fa fa-info-circle"></i> 路由规则配置说明：</strong>
                <ul style="margin: 5px 0 0 20px; font-size: 13px; color: #555;">
                    <li>URL 模式支持 <code>:param</code> 形式的动态参数。</li>
                    <li><strong>book (小说详情)</strong>: 必须包含 <code>:id</code> (小说ID)。例如 <code>/book/:id</code></li>
                    <li><strong>read (章节阅读)</strong>: 必须包含 <code>:aid</code> (小说ID) 和 <code>:cid</code> (章节ID)。例如
                        <code>/read/:aid/:cid</code>
                    </li>
                    <li><strong>sort (分类列表)</strong>: 必须包含 <code>:sortid</code> (分类ID) 和 <code>:page</code> (页码)。例如
                        <code>/sort/:sortid/:page</code>
                    </li>
                    <li><strong>book_index (小说目录)</strong>: 必须包含 <code>:id</code> (小说ID)。例如 <code>/show/:id</code></li>
                    <li><strong>top (排行榜)</strong>: 无必选参数。例如 <code>/top</code></li>
                </ul>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th width="30%">路由标识</th>
                            <th>URL 模式</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range $name, $pattern := .Routes}}
                        <tr>
                            <td>
                                <input type="text" name="{{$name}}" value="{{$pattern}}" class="form-control"
                                    style="width: 100%;">
                            </td>
                            <td>
                                <!-- 显示 Key 但不可修改，防止逻辑断裂 -->
                                <strong>{{$name}}</strong>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
            <div class="form-actions" style="margin-top: 20px; text-align: right;">
                <button type="submit" class="btn btn-primary">保存路由配置</button>
            </div>
        </form>
    </div>
</div>

<div id="sorts" class="tab-content">
    <div class="card">
        <form id="sorts-form" onsubmit="saveSorts(event)">
            <p style="color: #666; font-size: 13px; margin-bottom: 15px;">提示：排序权重越小越靠前</p>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th width="10%">ID</th>
                            <th width="30%">分类名称</th>
                            <th width="30%">简称</th>
                            <th width="20%">排序权重</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .Sorts}}
                        <tr class="sort-row">
                            <td>
                                {{.SortID}}
                                <input type="hidden" class="sort-id" value="{{.SortID}}">
                            </td>
                            <td><input type="text" class="form-control sort-caption" value="{{.Caption}}"></td>
                            <td><input type="text" class="form-control sort-short" value="{{.ShortName}}"></td>
                            <td><input type="number" class="form-control sort-weight" value="{{.Weight}}"></td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
            <div class="form-actions" style="margin-top: 20px; text-align: right;">
                <button type="submit" class="btn btn-primary">保存分类设置</button>
            </div>
        </form>
    </div>
</div>

<div id="seo" class="tab-content">
    <div class="card">
        <form id="seo-form" onsubmit="saveSeo(event)">
            <div class="alert alert-info" style="margin-bottom: 20px;">
                <strong><i class="fa fa-info-circle"></i> 标签说明：</strong>
                <span style="font-size: 13px; color: #555;">{sitename} (网站名), {articlename} (书名), {author} (作者),
                    {sortname} (分类), {page} (页码)</span>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px;">
                {{range $page, $rule := .SeoRules}}
                <div class="seo-item" data-page="{{$page}}"
                    style="background: #f9f9f9; padding: 15px; border-radius: 5px; border: 1px solid #eee;">
                    <div
                        style="border-bottom: 1px solid #ddd; padding-bottom: 8px; margin-bottom: 12px; font-weight: bold; font-size: 15px; display: flex; justify-content: space-between;">
                        <span>页面标识</span>
                        <span style="color: #d32f2f; font-family: monospace;">{{$page}}</span>
                    </div>

                    <div class="form-group" style="margin-bottom: 12px;">
                        <label
                            style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: bold; color: #555;">标题模板
                            (Title)</label>
                        <input type="text" class="form-control seo-title" value="{{$rule.Title}}"
                            style="width: 100%; padding: 8px; box-sizing: border-box;">
                    </div>

                    <div class="form-group" style="margin-bottom: 12px;">
                        <label
                            style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: bold; color: #555;">关键词
                            (Keywords)</label>
                        <input type="text" class="form-control seo-keywords" value="{{$rule.Keywords}}"
                            style="width: 100%; padding: 8px; box-sizing: border-box;">
                    </div>

                    <div class="form-group">
                        <label
                            style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: bold; color: #555;">描述
                            (Description)</label>
                        <textarea class="form-control seo-desc"
                            style="width: 100%; padding: 8px; height: 60px; resize: vertical; box-sizing: border-box;">{{$rule.Description}}</textarea>
                    </div>
                </div>
                {{end}}
            </div>

            <div class="form-actions"
                style="margin-top: 30px; text-align: center; position: sticky; bottom: 20px; z-index: 100;">
                <button type="submit" class="btn btn-primary"
                    style="padding: 10px 50px; font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">保存所有 SEO
                    配置</button>
            </div>
        </form>
    </div>
</div>

<script>
    function switchTab(btn, tabId) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        btn.classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }

    // 保存路由
    async function saveRoutes(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        // 修正：使用 URLSearchParams 发送 application/x-www-form-urlencoded 数据
        // 因为 Go 的 r.ParseForm() 默认不解析 multipart/form-data 的 Body
        const body = new URLSearchParams(formData);

        try {
            const res = await fetch('{{.AdminPath}}/modules/routes', {
                method: 'POST',
                body: body
            });
            const data = await res.json();
            if (data.success) {
                alert('保存成功');
                location.reload();
            } else {
                alert('保存失败: ' + data.message);
            }
        } catch (err) {
            alert('网络错误');
        }
    }

    // 保存分类
    async function saveSorts(e) {
        e.preventDefault();
        const rows = document.querySelectorAll('.sort-row');
        const sorts = [];
        rows.forEach(row => {
            sorts.push({
                sortid: parseInt(row.querySelector('.sort-id').value),
                caption: row.querySelector('.sort-caption').value,
                shortname: row.querySelector('.sort-short').value,
                weight: parseInt(row.querySelector('.sort-weight').value)
            });
        });

        try {
            const res = await fetch('{{.AdminPath}}/modules/sorts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(sorts)
            });
            const data = await res.json();
            if (data.success) {
                alert('保存成功');
                location.reload();
            } else {
                alert('保存失败: ' + data.message);
            }
        } catch (err) {
            alert('网络错误');
        }
    }

    // 保存 SEO
    async function saveSeo(e) {
        e.preventDefault();
        const rows = document.querySelectorAll('.seo-item');
        const seoRules = {};
        rows.forEach(row => {
            const page = row.dataset.page;
            seoRules[page] = {
                title: row.querySelector('.seo-title').value,
                keywords: row.querySelector('.seo-keywords').value,
                description: row.querySelector('.seo-desc').value
            };
        });

        try {
            const res = await fetch('{{.AdminPath}}/modules/seo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(seoRules)
            });
            const data = await res.json();
            if (data.success) {
                alert('保存成功');
                location.reload();
            } else {
                alert('保存失败: ' + data.message);
            }
        } catch (err) {
            alert('网络错误');
        }
    }
</script>
{{end}}