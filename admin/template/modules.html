{{define "content"}}
<div class="tabs">
    <div class="tab-btn active" onclick="switchTab(this, 'routes')">URL 路由设置</div>
    <div class="tab-btn" onclick="switchTab(this, 'recommend')">小说推荐设置</div>
    <div class="tab-btn" onclick="switchTab(this, 'sorts')">小说分类设置</div>
    <div class="tab-btn" onclick="switchTab(this, 'seo')">SEO 规则设置</div>
</div>

<div id="routes" class="tab-content active">
    <div class="settings-container">
        <form id="routes-form" onsubmit="saveRoutes(event)">
            <div class="alert alert-info"
                style="margin-bottom: 25px; border-left: 4px solid #3498db; background: #f8f9fa;">
                <strong><i class="fa fa-info-circle"></i> 路由规则配置说明：</strong>
                <ul style="margin: 5px 0 0 20px; font-size: 13px; color: #555;">
                    <li>URL 模式支持 <code>:param</code> 形式的动态参数。</li>
                    <li><strong>book (小说详情)</strong>: 必须包含 <code>:id</code> (小说ID)。例如 <code>/book/:id</code></li>
                    <li><strong>read (章节阅读)</strong>: 必须包含 <code>:aid</code> (小说ID) 和 <code>:cid</code> (章节ID)。例如
                        <code>/read/:aid/:cid</code>
                    </li>
                </ul>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th width="30%">路由标识</th>
                            <th>URL 模式</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range $name, $pattern := .Routes}}
                        <tr>
                            <td>
                                <input type="text" name="{{$name}}" value="{{$pattern}}" class="form-control"
                                    style="width: 100%;">
                            </td>
                            <td>
                                <strong>{{$name}}</strong>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
            <div class="form-row" style="margin-top: 20px; border-bottom: none;">
                <label class="form-label"></label>
                <div class="form-content">
                    <button type="submit" class="btn btn-primary">保存路由配置</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div id="recommend" class="tab-content">
    <div class="settings-container">
        <form id="recommend-form" onsubmit="saveRecommend(event)">
            <div class="alert alert-info"
                style="margin-bottom: 25px; border-left: 4px solid #3498db; background: #f8f9fa;">
                <strong><i class="fa fa-info-circle"></i> 推荐设置说明：</strong>
                <ul style="margin: 5px 0 0 20px; font-size: 13px; color: #555;">
                    <li><strong>排序方式</strong>: 决定推荐哪些书籍（例如：总访问量最高、最后更新等）。</li>
                    <li><strong>数量</strong>: 决定首页或侧边栏显示的条数。</li>
                </ul>
            </div>

            <div class="form-row">
                <label class="form-label">大神推荐 (Top)</label>
                <div class="form-content">
                    <div style="width: 100%;">
                        <div style="display: flex; gap: 20px;">
                            <div style="flex: 1;">
                                <label
                                    style="font-size: 12px; display:block; margin-bottom:5px; color:#666;">排序方式</label>
                                <select name="top_sort" class="form-control" style="width: 100%;">
                                    <option value="allvisit" {{if eq .Recommend.Top.Sort "allvisit" }}selected{{end}}>
                                        总访问量 (allvisit)</option>
                                    <option value="monthvisit" {{if eq .Recommend.Top.Sort "monthvisit"
                                        }}selected{{end}}>
                                        月访问量 (monthvisit)</option>
                                    <option value="weekvisit" {{if eq .Recommend.Top.Sort "weekvisit" }}selected{{end}}>
                                        周访问量 (weekvisit)</option>
                                    <option value="dayvisit" {{if eq .Recommend.Top.Sort "dayvisit" }}selected{{end}}>
                                        日访问量 (dayvisit)</option>
                                    <option value="postdate" {{if eq .Recommend.Top.Sort "postdate" }}selected{{end}}>
                                        入库时间 (postdate)</option>
                                    <option value="lastupdate" {{if eq .Recommend.Top.Sort "lastupdate"
                                        }}selected{{end}}>
                                        更新时间 (lastupdate)</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label
                                    style="font-size: 12px; display:block; margin-bottom:5px; color:#666;">显示数量</label>
                                <input type="number" name="top_limit" class="form-control"
                                    value="{{.Recommend.Top.Limit}}" style="width: 100%;">
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <label style="font-size: 12px; display:block; margin-bottom:5px; color:#666;">指定小说ID
                                (ID之间用逗号分隔，优先显示)</label>
                            <input type="text" name="top_picks" class="form-control" value="{{.Recommend.Top.Picks}}"
                                style="width: 100%;" placeholder="例如: 100,102,105">
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <label class="form-label">热门推荐 (Hot)</label>
                <div class="form-content">
                    <div style="width: 100%;">
                        <div style="display: flex; gap: 20px;">
                            <div style="flex: 1;">
                                <label
                                    style="font-size: 12px; display:block; margin-bottom:5px; color:#666;">排序方式</label>
                                <select name="hot_sort" class="form-control" style="width: 100%;">
                                    <option value="allvisit" {{if eq .Recommend.Hot.Sort "allvisit" }}selected{{end}}>
                                        总访问量 (allvisit)</option>
                                    <option value="monthvisit" {{if eq .Recommend.Hot.Sort "monthvisit"
                                        }}selected{{end}}>
                                        月访问量 (monthvisit)</option>
                                    <option value="weekvisit" {{if eq .Recommend.Hot.Sort "weekvisit" }}selected{{end}}>
                                        周访问量 (weekvisit)</option>
                                    <option value="dayvisit" {{if eq .Recommend.Hot.Sort "dayvisit" }}selected{{end}}>
                                        日访问量 (dayvisit)</option>
                                    <option value="postdate" {{if eq .Recommend.Hot.Sort "postdate" }}selected{{end}}>
                                        入库时间 (postdate)</option>
                                    <option value="lastupdate" {{if eq .Recommend.Hot.Sort "lastupdate"
                                        }}selected{{end}}>
                                        更新时间 (lastupdate)</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label
                                    style="font-size: 12px; display:block; margin-bottom:5px; color:#666;">显示数量</label>
                                <input type="number" name="hot_limit" class="form-control"
                                    value="{{.Recommend.Hot.Limit}}" style="width: 100%;">
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <label style="font-size: 12px; display:block; margin-bottom:5px; color:#666;">指定小说ID
                                (ID之间用逗号分隔，优先显示)</label>
                            <input type="text" name="hot_picks" class="form-control" value="{{.Recommend.Hot.Picks}}"
                                style="width: 100%;" placeholder="例如: 200,205,208">
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-row" style="margin-top: 20px; border-bottom: none;">
                <label class="form-label"></label>
                <div class="form-content">
                    <button type="submit" class="btn btn-primary">保存推荐设置</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div id="sorts" class="tab-content">
    <div class="settings-container">
        <form id="sorts-form" onsubmit="saveSorts(event)">
            <p style="color: #666; font-size: 13px; margin-bottom: 15px;">提示：排序权重越小越靠前</p>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th width="10%">ID</th>
                            <th width="30%">分类名称</th>
                            <th width="30%">简称</th>
                            <th width="20%">排序权重</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .Sorts}}
                        <tr class="sort-row">
                            <td>
                                {{.SortID}}
                                <input type="hidden" class="sort-id" value="{{.SortID}}">
                            </td>
                            <td><input type="text" class="form-control sort-caption" value="{{.Caption}}"></td>
                            <td><input type="text" class="form-control sort-short" value="{{.ShortName}}"></td>
                            <td><input type="number" class="form-control sort-weight" value="{{.Weight}}"></td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
            <div class="form-row" style="margin-top: 20px; border-bottom: none;">
                <label class="form-label"></label>
                <div class="form-content">
                    <button type="submit" class="btn btn-primary">保存分类设置</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div id="seo" class="tab-content">
    <div class="settings-container">
        <form id="seo-form" onsubmit="saveSeo(event)">
            <div class="alert alert-info"
                style="margin-bottom: 25px; border-left: 4px solid #3498db; background: #f8f9fa;">
                <strong><i class="fa fa-info-circle"></i> 标签说明：</strong>
                <span style="font-size: 13px; color: #555;">{sitename} (网站名), {articlename} (书名), {author} (作者),
                    {sortname} (分类), {page} (页码)</span>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px;">
                {{range $page, $rule := .SeoRules}}
                <div class="seo-item" data-page="{{$page}}"
                    style="background: #f9f9f9; padding: 20px; border-radius: 4px; border: 1px solid #e0e0e0;">
                    <div
                        style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; font-weight: 500; font-size: 15px; display: flex; justify-content: space-between; color: #2c3e50;">
                        <span>页面: {{$page}}</span>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label
                            style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #555;">标题模板
                            (Title)</label>
                        <input type="text" class="form-control seo-title" value="{{$rule.Title}}">
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label
                            style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #555;">关键词
                            (Keywords)</label>
                        <input type="text" class="form-control seo-keywords" value="{{$rule.Keywords}}">
                    </div>

                    <div>
                        <label
                            style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #555;">描述
                            (Description)</label>
                        <textarea class="form-control seo-desc"
                            style="height: 80px; resize: vertical;">{{$rule.Description}}</textarea>
                    </div>
                </div>
                {{end}}
            </div>

            <div class="form-actions"
                style="margin-top: 30px; text-align: center; position: sticky; bottom: 20px; z-index: 100;">
                <button type="submit" class="btn btn-primary"
                    style="padding: 10px 50px; font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">保存所有 SEO
                    配置</button>
            </div>
        </form>
    </div>
</div>

<script>
    function switchTab(btn, tabId) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        btn.classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }

    // 保存路由
    async function saveRoutes(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const body = new URLSearchParams(formData);

        try {
            const res = await fetch('{{.AdminPath}}/modules/routes', {
                method: 'POST',
                body: body
            });
            const data = await res.json();
            if (data.success) {
                alert('保存成功');
                location.reload();
            } else {
                alert('保存失败: ' + data.message);
            }
        } catch (err) {
            alert('网络错误');
        }
    }

    // 保存分类
    async function saveSorts(e) {
        e.preventDefault();
        const rows = document.querySelectorAll('.sort-row');
        const sorts = [];
        rows.forEach(row => {
            sorts.push({
                sortid: parseInt(row.querySelector('.sort-id').value),
                caption: row.querySelector('.sort-caption').value,
                shortname: row.querySelector('.sort-short').value,
                weight: parseInt(row.querySelector('.sort-weight').value)
            });
        });

        try {
            const res = await fetch('{{.AdminPath}}/modules/sorts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(sorts)
            });
            const data = await res.json();
            if (data.success) {
                alert('保存成功');
                location.reload();
            } else {
                alert('保存失败: ' + data.message);
            }
        } catch (err) {
            alert('网络错误');
        }
    }

    // 保存 SEO
    async function saveSeo(e) {
        e.preventDefault();
        const rows = document.querySelectorAll('.seo-item');
        const seoRules = {};
        rows.forEach(row => {
            const page = row.dataset.page;
            seoRules[page] = {
                title: row.querySelector('.seo-title').value,
                keywords: row.querySelector('.seo-keywords').value,
                description: row.querySelector('.seo-desc').value
            };
        });

        try {
            const res = await fetch('{{.AdminPath}}/modules/seo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(seoRules)
            });
            const data = await res.json();
            if (data.success) {
                alert('保存成功');
                location.reload();
            } else {
                alert('保存失败: ' + data.message);
            }
        } catch (err) {
            alert('网络错误');
        }
    }
    // 保存推荐设置
    async function saveRecommend(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const body = new URLSearchParams(formData);

        try {
            const res = await fetch('{{.AdminPath}}/modules/recommend', {
                method: 'POST',
                body: body
            });
            const data = await res.json();
            if (data.success) {
                alert('保存成功');
                location.reload();
            } else {
                alert('保存失败: ' + data.message);
            }
        } catch (err) {
            alert('网络错误');
        }
    }
</script>
{{end}}