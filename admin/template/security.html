{{define "content"}}

<div class="settings-container">
    <div class="settings-header">密码安全</div>
    <form id="passwordForm">
        <div class="form-row">
            <label class="form-label">原密码</label>
            <div class="form-content">
                <div class="form-control-wrapper">
                    <input type="password" name="old_password" class="form-control" required placeholder="请输入当前使用的密码">
                </div>
            </div>
        </div>
        <div class="form-row">
            <label class="form-label">新密码</label>
            <div class="form-content">
                <div class="form-control-wrapper">
                    <input type="password" name="new_password" class="form-control" required placeholder="请输入新密码">
                </div>
            </div>
        </div>
        <div class="form-row">
            <label class="form-label">确认新密码</label>
            <div class="form-content">
                <div class="form-control-wrapper">
                    <input type="password" name="confirm_password" class="form-control" required placeholder="请再次输入新密码">
                </div>
            </div>
        </div>
        <div class="form-row">
            <label class="form-label"></label>
            <div class="form-content">
                <button type="submit" class="btn btn-primary">修改密码</button>
            </div>
        </div>
    </form>

    <div class="settings-header" style="margin-top: 40px;">后台安全</div>
    <form id="pathForm">
        <div class="form-row">
            <label class="form-label">后台入口</label>
            <div class="form-content">
                <div class="form-control-wrapper">
                    <div style="display: flex; align-items: center;">
                        <span style="margin-right: 10px; color: #666; font-size: 14px;">{{.Domain}}</span>
                        <input type="text" name="admin_path" class="form-control" value="{{.AdminPath}}" required
                            pattern="^/[a-zA-Z0-9_-]+$" placeholder="/admin">
                    </div>
                </div>
                <span class="form-help">修改后需使用新地址登录。必须以 / 开头，仅限字母数字下划线。</span>
            </div>
        </div>
        <div class="form-row">
            <label class="form-label"></label>
            <div class="form-content">
                <button type="submit" class="btn btn-danger">保存并修改入口</button>
            </div>
        </div>
    </form>
</div>


<script>
    document.getElementById('passwordForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const params = new URLSearchParams();
        for (const pair of formData) {
            params.append(pair[0], pair[1]);
        }

        try {
            const res = await fetch('{{.AdminPath}}/security/password', {
                method: 'POST',
                body: params
            });
            const data = await res.json();
            alert(data.message);
            if (data.success) {
                this.reset();
            }
        } catch (err) {
            console.error(err);
            alert('网络错误');
        }
    });

    document.getElementById('pathForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        if (!confirm('确定要修改后台入口吗？')) return;

        const formData = new FormData(this);
        const params = new URLSearchParams();
        for (const pair of formData) {
            params.append(pair[0], pair[1]);
        }

        try {
            const res = await fetch('{{.AdminPath}}/security/path', {
                method: 'POST',
                body: params
            });
            const data = await res.json();
            alert(data.message);
            if (data.success) {
                alert('设置已保存。即将跳转到新地址登录。');
                setTimeout(() => {
                    location.href = data.new_path + '/';
                }, 1000);
            }
        } catch (err) {
            console.error(err);
            alert('网络错误');
        }
    });
</script>
{{end}}